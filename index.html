<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,
                 height=device-height,
                 initial-scale=1.0,
                 maximum-scale=1.0,
                 user-scalable=no" />
  <title>Telegram Roulette</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* Все ваши стили без изменений, только добавил класс .has-media в конец */
    /* ... (весь ваш CSS остаётся как есть) ... */
    
    /* ДОБАВЛЯЕМ СТИЛИ ДЛЯ УВЕЛИЧЕННЫХ ПОДАРКОВ */
    .selected-gift.has-media .gift-img,
    .selected-gift.has-media video.gift-img {
      width: 95% !important;
      height: 95% !important;
      border-radius: 12px;
      object-fit: cover;
      margin-bottom: 0;
      box-shadow: 0 4px 16px rgba(255, 215, 0, 0.6);
    }
    .selected-gift.has-media .gift-name {
      display: none;
    }
    /* Оставляем старый класс для совместимости */
    .selected-gift.durov-cap .gift-img {
      width: 95% !important;
      height: 95% !important;
      border-radius: 12px;
      object-fit: cover;
      margin-bottom: 0;
      box-shadow: 0 4px 16px rgba(255, 215, 0, 0.6);
    }
    .selected-gift.durov-cap .gift-name { display: none; }
  </style>
</head>
<body>
<!-- Вся разметка без изменений -->
<div id="app">...</div>
<div class="modal" id="giftModal">...</div>

<script>
  const tg = Telegram.WebApp;
  tg.ready();
  tg.expand();

  document.querySelector('#videoWrapper video').playbackRate = 0.7;

  const centerVideo = document.querySelector('.center-video');
  if (centerVideo) {
    centerVideo.pause();
    centerVideo.currentTime = 0;
  }

  let selectedGifts = [null, null, null, null];
  let currentSelectedSlot = null;
  let currentSlotElement = null;
  let filledSlots = new Array(4).fill(false);
  let videoPlayTimeout = null;
  let fourthGiftSelected = false;

  // ========== КАРТА СООТВЕТСТВИЯ ИМЁН ФАЙЛОВ ==========
  const fileMap = {
    "Durov's Cap": "Durov-Cap",
    "Astral Shard": "Astral Shard",
    "Kissed Frog": "Kissed Frog",
    "Artisan Brick": "Artisan Brick"
  };

  // Множество подарков, для которых есть медиа (чтобы применять увеличенный размер)
  const mediaGifts = new Set(["Astral Shard", "Kissed Frog", "Durov's Cap", "Artisan Brick"]);

  // Полный каталог подарков (имена и эмодзи) - без изменений
  const rareGifts = [ /* ... ваш полный список ... */ ];

  // Матрица (без изменений)
  const canvas = document.getElementById("matrix");
  const ctx = canvas.getContext("2d");
  let drops = [];
  const chars = "01ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789";
  const fontSize = 14;

  function initMatrix() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const columns = Math.floor(canvas.width / fontSize);
    drops = Array.from({ length: columns }, () => ({
      y: Math.random() * canvas.height,
      speed: 0.5 + Math.random() * 1.5
    }));
  }

  function drawMatrix() {
    ctx.fillStyle = "rgba(0, 0, 0, 0.08)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#00ff88";
    ctx.font = fontSize + "px monospace";

    drops.forEach((drop, i) => {
      const text = chars[Math.floor(Math.random() * chars.length)];
      ctx.fillText(text, i * fontSize, drop.y);
      drop.y += fontSize * drop.speed;
      if (drop.y > canvas.height + 50) {
        drop.y = Math.random() * -100;
        drop.speed = 0.5 + Math.random() * 1.5;
      }
    });
  }

  initMatrix();
  window.addEventListener("resize", initMatrix);
  setInterval(drawMatrix, 50);

  function playVideoFromStart() {
    if (centerVideo && !fourthGiftSelected) {
      if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
      centerVideo.currentTime = 0;
      centerVideo.play().catch(e => console.log('Ошибка воспроизведения видео'));
      videoPlayTimeout = setTimeout(() => {
        centerVideo.pause();
        centerVideo.currentTime = 0;
      }, 2000);
    }
  }

  function updateCenterSquareHighlight() {
    const centerSquare = document.getElementById('centerSquare');
    const filledCount = filledSlots.filter(filled => filled).length;
    if (filledCount > 0 && filledCount < 4 && !fourthGiftSelected) {
      centerSquare.classList.add('active-video');
    } else if (filledCount === 4) {
      centerSquare.classList.remove('active-video');
      centerSquare.classList.add('completed');
    } else {
      centerSquare.classList.remove('active-video', 'completed');
    }
  }

  // Функция для создания элемента подарка в КАТАЛОГЕ
  function createCatalogGiftElement(gift) {
    const container = document.createElement('div');
    container.className = 'gift-img';

    const baseName = fileMap[gift.name] || gift.name;
    const encodedName = encodeURIComponent(baseName);

    const img = new Image();
    img.src = `videos/${encodedName}.png`;
    img.alt = gift.name;
    img.onerror = () => {
      container.innerHTML = '';
      const emoji = document.createElement('div');
      emoji.className = 'gift-emoji';
      emoji.textContent = gift.emoji;
      container.appendChild(emoji);
    };
    container.appendChild(img);
    return container;
  }

  // Функция для создания содержимого СЛОТА или КУБА (видео)
  function createGiftContent(gift, forSlot = false) {
    const container = document.createElement('div');
    container.className = 'selected-gift active';
    
    // Если подарок есть в mediaGifts, добавляем класс для увеличенного размера
    if (mediaGifts.has(gift.name)) {
      container.classList.add('has-media');
    }

    const baseName = fileMap[gift.name] || gift.name;
    const encodedName = encodeURIComponent(baseName);

    const tryCreateVideo = () => {
      const video = document.createElement('video');
      video.className = 'gift-img';
      video.src = `videos/${encodedName}.mp4`;
      video.muted = true;
      video.loop = true;
      video.autoplay = true;
      video.playsInline = true;
      video.setAttribute('webkit-playsinline', '');

      video.onerror = () => {
        // Пробуем показать изображение
        const img = new Image();
        img.onload = () => {
          container.innerHTML = '';
          img.className = 'gift-img';
          container.appendChild(img);
        };
        img.onerror = () => {
          container.innerHTML = '';
          const emoji = document.createElement('div');
          emoji.className = 'gift-emoji';
          emoji.textContent = gift.emoji;
          container.appendChild(emoji);
        };
        img.src = `videos/${encodedName}.png`;
      };

      video.oncanplay = () => video.play().catch(() => {});
      return video;
    };

    if (forSlot) {
      container.appendChild(tryCreateVideo());
    } else {
      // для каталога не используется
      const img = new Image();
      img.className = 'gift-img';
      img.src = `videos/${encodedName}.png`;
      img.alt = gift.name;
      img.onerror = () => {
        container.innerHTML = '';
        const emoji = document.createElement('div');
        emoji.className = 'gift-emoji';
        emoji.textContent = gift.emoji;
        container.appendChild(emoji);
      };
      container.appendChild(img);
    }

    return container;
  }

  // Удаление подарка из слота
  function removeGiftFromSlot(slotIndex, event) {
    event.stopPropagation();
    const slotElement = document.querySelector(`.mini-square[data-slot="${slotIndex}"]`);
    const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);

    selectedGifts[slotIndex] = null;
    filledSlots[slotIndex] = false;
    fourthGiftSelected = false;

    slotGiftContainer.innerHTML = '';
    slotGiftContainer.classList.remove('active', 'durov-cap', 'has-media');
    slotElement.querySelector('.plus-sign').style.opacity = '1';
    slotElement.classList.remove('filled');

    const removeBtn = slotElement.querySelector('.remove-gift');
    if (removeBtn) removeBtn.remove();

    updateCenterSquareHighlight();

    if (centerVideo) {
      centerVideo.pause();
      centerVideo.currentTime = 0;
      if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
    }

    updateModalSelection();
  }

  // Обновление выделения в модальном окне
  function updateModalSelection() {
    const giftItems = document.querySelectorAll('.gift-item');
    giftItems.forEach(item => {
      item.classList.remove('selected');
      const removeBtn = item.querySelector('.remove-selected');
      if (removeBtn) removeBtn.remove();
    });

    selectedGifts.forEach((gift, index) => {
      if (gift) {
        const giftItem = Array.from(giftItems).find(item => item.dataset.name === gift.name);
        if (giftItem) {
          giftItem.classList.add('selected');
          if (!giftItem.querySelector('.remove-selected')) {
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-selected';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = (e) => {
              e.stopPropagation();
              removeGiftFromSlot(index, e);
            };
            giftItem.appendChild(removeBtn);
          }
        }
      }
    });
  }

  // Создание 3D куба (БЕЗ ВЕРХНЕЙ И НИЖНЕЙ ГРАНЕЙ)
  function createGiftCube() {
    const cubeFaces = [
      document.getElementById('cube-face-0'),
      document.getElementById('cube-face-1'),
      document.getElementById('cube-face-2'),
      document.getElementById('cube-face-3')
    ];

    cubeFaces.forEach((face, index) => {
      if (selectedGifts[index]) {
        const gift = selectedGifts[index];
        const content = createGiftContent(gift, true);
        face.innerHTML = '';
        face.appendChild(content);
      } else {
        // Если подарок не выбран, оставляем грань пустой (можно очистить)
        face.innerHTML = '';
      }
    });

    // Верхняя и нижняя грани остаются пустыми (ничего не вставляем)
    // (они уже есть в разметке, но без содержимого)
  }

  function mergeToCube() {
    const cornersContainer = document.getElementById('cornersContainer');
    const centerSquare = document.getElementById('centerSquare');
    const giftCubeContainer = document.getElementById('giftCubeContainer');

    cornersContainer.classList.add('merged');
    centerSquare.classList.add('merged');

    createGiftCube();
    giftCubeContainer.classList.add('active');
  }

  // Интеллектуальный поиск (без изменений)
  function sortGiftsByRelevance(gifts, searchTerm) {
    if (!searchTerm) return gifts;
    searchTerm = searchTerm.toLowerCase();
    return gifts.sort((a, b) => {
      const scoreA = getSearchScore(a.name, searchTerm);
      const scoreB = getSearchScore(b.name, searchTerm);
      if (scoreA !== scoreB) return scoreB - scoreA;
      return a.name.localeCompare(b.name);
    });
  }

  function getSearchScore(name, searchTerm) {
    const lowerName = name.toLowerCase();
    if (lowerName.startsWith(searchTerm)) return 1000;
    if (lowerName.includes(` ${searchTerm}`)) return 800;
    if (lowerName[0] === searchTerm[0]) return 500;
    if (lowerName.includes(searchTerm)) return 100;
    return 0;
  }

  // Фильтрация и отрисовка сетки
  function filterAndSortGifts(searchTerm) {
    const filteredGifts = rareGifts.filter(gift =>
      gift.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
    const sortedGifts = sortGiftsByRelevance(filteredGifts, searchTerm);

    const grid = document.getElementById('giftsGrid');
    grid.innerHTML = '';

    sortedGifts.forEach(gift => {
      const item = document.createElement('div');
      item.className = 'gift-item';
      item.dataset.name = gift.name;

      const imgDiv = createCatalogGiftElement(gift);
      const nameDiv = document.createElement('div');
      nameDiv.className = 'gift-name';
      nameDiv.textContent = gift.name;

      item.appendChild(imgDiv);
      item.appendChild(nameDiv);
      item.onclick = () => selectGiftForSlot(gift, currentSlotElement);
      grid.appendChild(item);
    });

    updateModalSelection();
  }

  function showGifts(slotElement) {
    currentSelectedSlot = slotElement.dataset.slot;
    currentSlotElement = slotElement;
    filterAndSortGifts('');
    document.getElementById('giftModal').classList.add('active');
  }

  // Выбор подарка для слота
  function selectGiftForSlot(gift, slotElement) {
    const slotIndex = parseInt(currentSelectedSlot);
    if (filledSlots[slotIndex]) return;

    const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);
    selectedGifts[slotIndex] = gift;
    filledSlots[slotIndex] = true;

    slotGiftContainer.innerHTML = '';
    const content = createGiftContent(gift, true);
    slotGiftContainer.appendChild(content);

    slotGiftContainer.classList.add('active');
    // Для совместимости оставляем старый класс, но новый класс .has-media уже добавлен в createGiftContent
    if (gift.name === "Durov's Cap") {
      slotGiftContainer.classList.add('durov-cap');
    }

    slotElement.querySelector('.plus-sign').style.opacity = '0';
    slotElement.classList.add('filled');

    const removeBtn = document.createElement('div');
    removeBtn.className = 'remove-gift';
    removeBtn.innerHTML = '×';
    removeBtn.onclick = (e) => removeGiftFromSlot(slotIndex, e);
    slotElement.appendChild(removeBtn);

    const filledCount = filledSlots.filter(filled => filled).length;
    if (filledCount === 4) {
      fourthGiftSelected = true;
      if (centerVideo) {
        centerVideo.pause();
        centerVideo.currentTime = 0;
        if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
      }
      updateCenterSquareHighlight();
    } else {
      playVideoFromStart();
      updateCenterSquareHighlight();
    }

    updateModalSelection();
    document.getElementById('giftModal').classList.remove('active');
  }

  // Инициализация (без изменений)
  const user = tg.initDataUnsafe?.user;
  if (user && user.photo_url) {
    const avatar = document.getElementById("avatar");
    const img = document.createElement("img");
    img.src = user.photo_url;
    avatar.appendChild(img);

    setTimeout(() => {
      document.getElementById("matrix").style.opacity = "0";
      document.getElementById("videoWrapper").style.opacity = "0";
      document.getElementById("blackScreen").style.opacity = "1";
    }, 3000);

    setTimeout(() => {
      avatar.style.opacity = "1";
      document.getElementById("mainSquare").style.opacity = "1";

      document.querySelectorAll('.mini-square').forEach(square => {
        square.onclick = (e) => {
          if (e.target.classList.contains('remove-gift')) return;
          showGifts(square);
        };
      });

      document.getElementById('centerSquare').onclick = () => {
        if (filledSlots.filter(filled => filled).length === 4) {
          mergeToCube();
        }
      };
    }, 3500);
  }

  // Обработчики модального окна
  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    filterAndSortGifts(e.target.value);
  });

  document.getElementById('closeModal').onclick = () => {
    document.getElementById('giftModal').classList.remove('active');
  };

  document.getElementById('giftModal').onclick = (e) => {
    if (e.target === document.getElementById('giftModal')) {
      document.getElementById('giftModal').classList.remove('active');
    }
  };
</script>

<!-- Предзагрузка изображений для четырёх подарков (без изменений) -->
<script>
  (function preloadImages() {
    var gifts = ["Astral Shard", "Kissed Frog", "Durov's Cap", "Artisan Brick"];
    var fileMap = {
      "Durov's Cap": "Durov-Cap",
      "Astral Shard": "Astral Shard",
      "Kissed Frog": "Kissed Frog",
      "Artisan Brick": "Artisan Brick"
    };
    gifts.forEach(function(name) {
      var baseName = fileMap[name] || name;
      var img = new Image();
      img.src = 'videos/' + encodeURIComponent(baseName) + '.png';
    });
  })();
</script>

</body>
</html>