<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,
                 height=device-height,
                 initial-scale=1.0,
                 maximum-scale=1.0,
                 user-scalable=no" />
  <title>Telegram Roulette</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –í—Å–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–¥–∞) */
    /* ... */
  </style>
</head>
<body>
<div id="app">
  <!-- –í—Å—è —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
  <!-- ... -->
</div>
<div class="modal" id="giftModal"><!-- ... --></div>

<script>
  (async function() {
    const tg = Telegram.WebApp;
    tg.ready();
    tg.expand();

    document.querySelector('#videoWrapper video').playbackRate = 0.7;

    const centerVideo = document.querySelector('.center-video');
    if (centerVideo) {
      centerVideo.pause();
      centerVideo.currentTime = 0;
    }

    let selectedGifts = [null, null, null, null];
    let currentSelectedSlot = null;
    let currentSlotElement = null;
    let filledSlots = new Array(4).fill(false);
    let videoPlayTimeout = null;
    let fourthGiftSelected = false;

    // –î–∞–Ω–Ω—ã–µ –∏–∑ manifest.json
    let pngFiles = new Set();
    let mp4Files = new Set();
    let manifestLoaded = false;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç
    try {
      const response = await fetch('videos/manifest.json');
      if (response.ok) {
        const manifest = await response.json();
        pngFiles = new Set(manifest.png || []);
        mp4Files = new Set(manifest.mp4 || []);
        manifestLoaded = true;
        console.log('Manifest loaded');
      } else {
        console.warn('Manifest not found, using fallback');
      }
    } catch (e) {
      console.warn('Manifest loading failed, using fallback');
    }

    // –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–¥–∞—Ä–∫–æ–≤ (–∏–º–µ–Ω–∞ –∏ —ç–º–æ–¥–∑–∏)
    const rareGifts = [ /* ... –≤–∞—à –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ ... */ ];

    // –ú–∞—Ç—Ä–∏—Ü–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    const canvas = document.getElementById("matrix");
    const ctx = canvas.getContext("2d");
    let drops = [];
    const chars = "01ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789";
    const fontSize = 14;

    function initMatrix() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const columns = Math.floor(canvas.width / fontSize);
      drops = Array.from({ length: columns }, () => ({
        y: Math.random() * canvas.height,
        speed: 0.5 + Math.random() * 1.5
      }));
    }

    function drawMatrix() {
      ctx.fillStyle = "rgba(0, 0, 0, 0.08)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#00ff88";
      ctx.font = fontSize + "px monospace";
      drops.forEach((drop, i) => {
        const text = chars[Math.floor(Math.random() * chars.length)];
        ctx.fillText(text, i * fontSize, drop.y);
        drop.y += fontSize * drop.speed;
        if (drop.y > canvas.height + 50) {
          drop.y = Math.random() * -100;
          drop.speed = 0.5 + Math.random() * 1.5;
        }
      });
    }

    initMatrix();
    window.addEventListener("resize", initMatrix);
    setInterval(drawMatrix, 50);

    // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ—Ü–µ–Ω—Ç—Ä–æ–º
    function playVideoFromStart() {
      if (centerVideo && !fourthGiftSelected) {
        if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
        centerVideo.currentTime = 0;
        centerVideo.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ'));
        videoPlayTimeout = setTimeout(() => {
          centerVideo.pause();
          centerVideo.currentTime = 0;
        }, 2000);
      }
    }

    function updateCenterSquareHighlight() {
      const centerSquare = document.getElementById('centerSquare');
      const filledCount = filledSlots.filter(filled => filled).length;
      if (filledCount > 0 && filledCount < 4 && !fourthGiftSelected) {
        centerSquare.classList.add('active-video');
      } else if (filledCount === 4) {
        centerSquare.classList.remove('active-video');
        centerSquare.classList.add('completed');
      } else {
        centerSquare.classList.remove('active-video', 'completed');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ–¥–∞—Ä–∫–∞ –≤ –ö–ê–¢–ê–õ–û–ì–ï (PNG –∏–ª–∏ —ç–º–æ–¥–∑–∏)
    function createCatalogGiftElement(gift) {
      const container = document.createElement('div');
      container.className = 'gift-img';

      if (manifestLoaded) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
        const fileName = `${gift.name}.png`;
        if (pngFiles.has(fileName)) {
          const img = new Image();
          img.src = `videos/${encodeURIComponent(gift.name)}.png`;
          img.alt = gift.name;
          container.appendChild(img);
        } else {
          const emoji = document.createElement('div');
          emoji.className = 'gift-emoji';
          emoji.textContent = gift.emoji;
          container.appendChild(emoji);
        }
      } else {
        // Fallback: –ø—Ä–æ–±–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        const img = new Image();
        img.src = `videos/${encodeURIComponent(gift.name)}.png`;
        img.alt = gift.name;
        img.onerror = () => {
          container.innerHTML = '';
          const emoji = document.createElement('div');
          emoji.className = 'gift-emoji';
          emoji.textContent = gift.emoji;
          container.appendChild(emoji);
        };
        container.appendChild(img);
      }
      return container;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –°–õ–û–¢–ê –∏–ª–∏ –ö–£–ë–ê (–≤–∏–¥–µ–æ -> PNG -> —ç–º–æ–¥–∑–∏)
    function createSlotGiftContent(gift) {
      const wrapper = document.createElement('div');
      wrapper.className = 'selected-gift active';

      if (manifestLoaded) {
        const mp4Name = `${gift.name}.mp4`;
        const pngName = `${gift.name}.png`;

        if (mp4Files.has(mp4Name)) {
          const video = document.createElement('video');
          video.className = 'gift-img';
          video.src = `videos/${encodeURIComponent(gift.name)}.mp4`;
          video.muted = true;
          video.loop = true;
          video.autoplay = true;
          video.playsInline = true;
          video.setAttribute('webkit-playsinline', '');
          wrapper.appendChild(video);
        } else if (pngFiles.has(pngName)) {
          const img = new Image();
          img.className = 'gift-img';
          img.src = `videos/${encodeURIComponent(gift.name)}.png`;
          img.alt = gift.name;
          wrapper.appendChild(img);
        } else {
          const emoji = document.createElement('div');
          emoji.className = 'gift-emoji';
          emoji.textContent = gift.emoji;
          wrapper.appendChild(emoji);
        }
      } else {
        // Fallback: –ø—Ä–æ–±—É–µ–º –≤–∏–¥–µ–æ, –∑–∞—Ç–µ–º PNG, –∑–∞—Ç–µ–º —ç–º–æ–¥–∑–∏
        const video = document.createElement('video');
        video.className = 'gift-img';
        video.src = `videos/${encodeURIComponent(gift.name)}.mp4`;
        video.muted = true;
        video.loop = true;
        video.autoplay = true;
        video.playsInline = true;
        video.setAttribute('webkit-playsinline', '');
        video.onerror = () => {
          wrapper.innerHTML = '';
          const img = new Image();
          img.className = 'gift-img';
          img.src = `videos/${encodeURIComponent(gift.name)}.png`;
          img.alt = gift.name;
          img.onerror = () => {
            wrapper.innerHTML = '';
            const emoji = document.createElement('div');
            emoji.className = 'gift-emoji';
            emoji.textContent = gift.emoji;
            wrapper.appendChild(emoji);
          };
          wrapper.appendChild(img);
        };
        wrapper.appendChild(video);
      }
      return wrapper;
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ –∏–∑ —Å–ª–æ—Ç–∞
    function removeGiftFromSlot(slotIndex, event) {
      event.stopPropagation();
      const slotElement = document.querySelector(`.mini-square[data-slot="${slotIndex}"]`);
      const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);

      selectedGifts[slotIndex] = null;
      filledSlots[slotIndex] = false;
      fourthGiftSelected = false;

      slotGiftContainer.innerHTML = '';
      slotGiftContainer.classList.remove('active', 'durov-cap');
      slotElement.querySelector('.plus-sign').style.opacity = '1';
      slotElement.classList.remove('filled');

      const removeBtn = slotElement.querySelector('.remove-gift');
      if (removeBtn) removeBtn.remove();

      updateCenterSquareHighlight();

      if (centerVideo) {
        centerVideo.pause();
        centerVideo.currentTime = 0;
        if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
      }

      updateModalSelection();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    function updateModalSelection() {
      const giftItems = document.querySelectorAll('.gift-item');
      giftItems.forEach(item => {
        item.classList.remove('selected');
        const removeBtn = item.querySelector('.remove-selected');
        if (removeBtn) removeBtn.remove();
      });

      selectedGifts.forEach((gift, index) => {
        if (gift) {
          const giftItem = Array.from(giftItems).find(item => item.dataset.name === gift.name);
          if (giftItem) {
            giftItem.classList.add('selected');
            if (!giftItem.querySelector('.remove-selected')) {
              const removeBtn = document.createElement('div');
              removeBtn.className = 'remove-selected';
              removeBtn.innerHTML = '√ó';
              removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeGiftFromSlot(index, e);
              };
              giftItem.appendChild(removeBtn);
            }
          }
        }
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ 3D –∫—É–±–∞
    function createGiftCube() {
      const cubeFaces = [
        document.getElementById('cube-face-0'),
        document.getElementById('cube-face-1'),
        document.getElementById('cube-face-2'),
        document.getElementById('cube-face-3')
      ];

      cubeFaces.forEach((face, index) => {
        if (selectedGifts[index]) {
          const gift = selectedGifts[index];
          const content = createSlotGiftContent(gift);
          face.innerHTML = '';
          face.appendChild(content);
        }
      });

      const topFace = document.querySelector('.cube-face.top');
      const bottomFace = document.querySelector('.cube-face.bottom');
      if (selectedGifts[0]) {
        topFace.innerHTML = '<div class="selected-gift active"><div class="gift-emoji">‚ú®</div></div>';
        bottomFace.innerHTML = '<div class="selected-gift active"><div class="gift-emoji">üí´</div></div>';
      }
    }

    function mergeToCube() {
      const cornersContainer = document.getElementById('cornersContainer');
      const centerSquare = document.getElementById('centerSquare');
      const giftCubeContainer = document.getElementById('giftCubeContainer');

      cornersContainer.classList.add('merged');
      centerSquare.classList.add('merged');

      createGiftCube();
      giftCubeContainer.classList.add('active');
    }

    // –ü–æ–∏—Å–∫
    function sortGiftsByRelevance(gifts, searchTerm) {
      if (!searchTerm) return gifts;
      searchTerm = searchTerm.toLowerCase();
      return gifts.sort((a, b) => {
        const scoreA = getSearchScore(a.name, searchTerm);
        const scoreB = getSearchScore(b.name, searchTerm);
        if (scoreA !== scoreB) return scoreB - scoreA;
        return a.name.localeCompare(b.name);
      });
    }

    function getSearchScore(name, searchTerm) {
      const lowerName = name.toLowerCase();
      if (lowerName.startsWith(searchTerm)) return 1000;
      if (lowerName.includes(` ${searchTerm}`)) return 800;
      if (lowerName[0] === searchTerm[0]) return 500;
      if (lowerName.includes(searchTerm)) return 100;
      return 0;
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏
    function filterAndSortGifts(searchTerm) {
      const filteredGifts = rareGifts.filter(gift =>
        gift.name.toLowerCase().includes(searchTerm.toLowerCase())
      );
      const sortedGifts = sortGiftsByRelevance(filteredGifts, searchTerm);

      const grid = document.getElementById('giftsGrid');
      grid.innerHTML = '';

      sortedGifts.forEach(gift => {
        const item = document.createElement('div');
        item.className = 'gift-item';
        item.dataset.name = gift.name;

        const imgDiv = createCatalogGiftElement(gift);
        const nameDiv = document.createElement('div');
        nameDiv.className = 'gift-name';
        nameDiv.textContent = gift.name;

        item.appendChild(imgDiv);
        item.appendChild(nameDiv);
        item.onclick = () => selectGiftForSlot(gift, currentSlotElement);
        grid.appendChild(item);
      });

      updateModalSelection();
    }

    function showGifts(slotElement) {
      currentSelectedSlot = slotElement.dataset.slot;
      currentSlotElement = slotElement;
      filterAndSortGifts('');
      document.getElementById('giftModal').classList.add('active');
    }

    // –í—ã–±–æ—Ä –ø–æ–¥–∞—Ä–∫–∞ –¥–ª—è —Å–ª–æ—Ç–∞
    function selectGiftForSlot(gift, slotElement) {
      const slotIndex = parseInt(currentSelectedSlot);
      if (filledSlots[slotIndex]) return;

      const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);
      selectedGifts[slotIndex] = gift;
      filledSlots[slotIndex] = true;

      slotGiftContainer.innerHTML = '';
      const content = createSlotGiftContent(gift);
      slotGiftContainer.appendChild(content);

      slotGiftContainer.classList.add('active');
      if (gift.name === "Durov's Cap") slotGiftContainer.classList.add('durov-cap');

      slotElement.querySelector('.plus-sign').style.opacity = '0';
      slotElement.classList.add('filled');

      const removeBtn = document.createElement('div');
      removeBtn.className = 'remove-gift';
      removeBtn.innerHTML = '√ó';
      removeBtn.onclick = (e) => removeGiftFromSlot(slotIndex, e);
      slotElement.appendChild(removeBtn);

      const filledCount = filledSlots.filter(filled => filled).length;
      if (filledCount === 4) {
        fourthGiftSelected = true;
        if (centerVideo) {
          centerVideo.pause();
          centerVideo.currentTime = 0;
          if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
        }
        updateCenterSquareHighlight();
      } else {
        playVideoFromStart();
        updateCenterSquareHighlight();
      }

      updateModalSelection();
      document.getElementById('giftModal').classList.remove('active');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const user = tg.initDataUnsafe?.user;
    if (user && user.photo_url) {
      const avatar = document.getElementById("avatar");
      const img = document.createElement("img");
      img.src = user.photo_url;
      avatar.appendChild(img);

      setTimeout(() => {
        document.getElementById("matrix").style.opacity = "0";
        document.getElementById("videoWrapper").style.opacity = "0";
        document.getElementById("blackScreen").style.opacity = "1";
      }, 3000);

      setTimeout(() => {
        avatar.style.opacity = "1";
        document.getElementById("mainSquare").style.opacity = "1";

        document.querySelectorAll('.mini-square').forEach(square => {
          square.onclick = (e) => {
            if (e.target.classList.contains('remove-gift')) return;
            showGifts(square);
          };
        });

        document.getElementById('centerSquare').onclick = () => {
          if (filledSlots.filter(filled => filled).length === 4) {
            mergeToCube();
          }
        };
      }, 3500);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      filterAndSortGifts(e.target.value);
    });

    document.getElementById('closeModal').onclick = () => {
      document.getElementById('giftModal').classList.remove('active');
    };

    document.getElementById('giftModal').onclick = (e) => {
      if (e.target === document.getElementById('giftModal')) {
        document.getElementById('giftModal').classList.remove('active');
      }
    };
  })();
</script>
</body>
</html>