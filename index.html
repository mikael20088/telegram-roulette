<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Telegram Roulette</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–≤–æ–∑—å–º–∏—Ç–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π) */
    /* ... */
  </style>
</head>
<body>
<div id="app"><!-- —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π --></div>
<div class="modal" id="giftModal"><!-- ... --></div>

<script>
(function() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  async function init() {
    try {
      const tg = Telegram.WebApp;
      tg.ready();
      tg.expand();

      // ----- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï -----
      let selectedGifts = [null, null, null, null];
      let filledSlots = [false, false, false, false];
      let fourthGiftSelected = false;
      let videoPlayTimeout = null;
      let currentSelectedSlot = null;
      let currentSlotElement = null;

      // –ö—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–æ–≤: true = —Ñ–∞–π–ª –µ—Å—Ç—å, false = –Ω–µ—Ç
      const pngCache = new Map();  // –∫–ª—é—á = –∏–º—è –ø–æ–¥–∞—Ä–∫–∞
      const mp4Cache = new Map();

      // ----- –ö–ê–¢–ê–õ–û–ì –ü–û–î–ê–†–ö–û–í (—Ç–æ–ª—å–∫–æ –∏–º–µ–Ω–∞ –∏ —ç–º–æ–¥–∑–∏) -----
      const rareGifts = [
        { name: "Durov's Cap", emoji: "üé©" },
        { name: "Top Hat", emoji: "üé©" },
        { name: "Astral Shard", emoji: "üíé" },
        { name: "Mini Oscar", emoji: "üèÜ" },
        { name: "Electric Skull", emoji: "üíÄ" },
        // ... –≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å–ø–∏—Å–æ–∫ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π (80+)
      ];

      // ----- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –° –ö–≠–®–ï–ú -----
      function checkPng(gift) {
        if (pngCache.has(gift.name)) {
          return Promise.resolve(pngCache.get(gift.name));
        }
        return new Promise(resolve => {
          const img = new Image();
          img.onload = () => {
            pngCache.set(gift.name, true);
            resolve(true);
          };
          img.onerror = () => {
            pngCache.set(gift.name, false);
            resolve(false);
          };
          img.src = `videos/${encodeURIComponent(gift.name)}.png`;
        });
      }

      function checkMp4(gift) {
        if (mp4Cache.has(gift.name)) {
          return Promise.resolve(mp4Cache.get(gift.name));
        }
        return new Promise(resolve => {
          const video = document.createElement('video');
          video.oncanplaythrough = () => {
            mp4Cache.set(gift.name, true);
            resolve(true);
          };
          video.onerror = () => {
            mp4Cache.set(gift.name, false);
            resolve(false);
          };
          video.src = `videos/${encodeURIComponent(gift.name)}.mp4`;
        });
      }

      // ----- –°–û–ó–î–ê–ù–ò–ï –≠–õ–ï–ú–ï–ù–¢–û–í -----
      // –î–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–æ —Å –∫—ç—à–µ–º)
      async function createCatalogGiftElement(gift) {
        const container = document.createElement('div');
        container.className = 'gift-img';

        const hasPng = await checkPng(gift);
        if (hasPng) {
          const img = new Image();
          img.src = `videos/${encodeURIComponent(gift.name)}.png`;
          img.alt = gift.name;
          img.onerror = () => {
            // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫—ç—à –æ—à–∏–±–∞–µ—Ç—Å—è
            container.innerHTML = '';
            const emoji = document.createElement('div');
            emoji.className = 'gift-emoji';
            emoji.textContent = gift.emoji;
            container.appendChild(emoji);
          };
          container.appendChild(img);
        } else {
          const emoji = document.createElement('div');
          emoji.className = 'gift-emoji';
          emoji.textContent = gift.emoji;
          container.appendChild(emoji);
        }
        return container;
      }

      // –î–ª—è —Å–ª–æ—Ç–æ–≤ –∏ –∫—É–±–∞ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞)
      async function createSlotGiftContent(gift) {
        const wrapper = document.createElement('div');
        wrapper.className = 'selected-gift active';

        const hasMp4 = await checkMp4(gift);
        if (hasMp4) {
          const video = document.createElement('video');
          video.className = 'gift-img';
          video.src = `videos/${encodeURIComponent(gift.name)}.mp4`;
          video.muted = true;
          video.loop = true;
          video.autoplay = true;
          video.playsInline = true;
          video.setAttribute('webkit-playsinline', '');
          video.onerror = () => {
            // –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É
            wrapper.innerHTML = '';
            createFallbackImage().then(fb => wrapper.appendChild(fb));
          };
          wrapper.appendChild(video);
        } else {
          const hasPng = await checkPng(gift);
          if (hasPng) {
            const img = new Image();
            img.className = 'gift-img';
            img.src = `videos/${encodeURIComponent(gift.name)}.png`;
            img.alt = gift.name;
            img.onerror = () => {
              wrapper.innerHTML = '';
              const emoji = document.createElement('div');
              emoji.className = 'gift-emoji';
              emoji.textContent = gift.emoji;
              wrapper.appendChild(emoji);
            };
            wrapper.appendChild(img);
          } else {
            const emoji = document.createElement('div');
            emoji.className = 'gift-emoji';
            emoji.textContent = gift.emoji;
            wrapper.appendChild(emoji);
          }
        }
        return wrapper;
      }

      // ----- –ú–ê–¢–†–ò–¶–ê (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -----
      const canvas = document.getElementById('matrix');
      const ctx = canvas.getContext('2d');
      let drops = [];
      const chars = '01ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789';
      const fontSize = 14;

      function initMatrix() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const columns = Math.floor(canvas.width / fontSize);
        drops = Array.from({ length: columns }, () => ({
          y: Math.random() * canvas.height,
          speed: 0.5 + Math.random() * 1.5
        }));
      }

      function drawMatrix() {
        ctx.fillStyle = 'rgba(0,0,0,0.08)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#00ff88';
        ctx.font = fontSize + 'px monospace';
        drops.forEach(drop => {
          const text = chars[Math.floor(Math.random() * chars.length)];
          ctx.fillText(text, drop.x, drop.y);
          drop.y += fontSize * drop.speed;
          if (drop.y > canvas.height + 50) {
            drop.y = Math.random() * -100;
            drop.speed = 0.5 + Math.random() * 1.5;
          }
        });
      }

      window.addEventListener('resize', initMatrix);
      initMatrix();
      setInterval(drawMatrix, 50);

      // ----- –í–ò–î–ï–û–¶–ï–ù–¢–† (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -----
      const centerVideo = document.querySelector('.center-video');
      if (centerVideo) {
        centerVideo.pause();
        centerVideo.currentTime = 0;
      }

      function playVideoFromStart() {
        if (centerVideo && !fourthGiftSelected) {
          if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
          centerVideo.currentTime = 0;
          centerVideo.play().catch(() => {});
          videoPlayTimeout = setTimeout(() => {
            centerVideo.pause();
            centerVideo.currentTime = 0;
          }, 2000);
        }
      }

      function updateCenterSquareHighlight() {
        const centerSquare = document.getElementById('centerSquare');
        if (!centerSquare) return;
        const filledCount = filledSlots.filter(Boolean).length;
        if (filledCount > 0 && filledCount < 4 && !fourthGiftSelected) {
          centerSquare.classList.add('active-video');
        } else if (filledCount === 4) {
          centerSquare.classList.remove('active-video');
          centerSquare.classList.add('completed');
        } else {
          centerSquare.classList.remove('active-video', 'completed');
        }
      }

      // ----- –£–î–ê–õ–ï–ù–ò–ï –ü–û–î–ê–†–ö–ê (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -----
      function removeGiftFromSlot(slotIndex, event) {
        event.stopPropagation();
        const slotElement = document.querySelector(`.mini-square[data-slot="${slotIndex}"]`);
        const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);
        if (!slotElement || !slotGiftContainer) return;

        selectedGifts[slotIndex] = null;
        filledSlots[slotIndex] = false;
        fourthGiftSelected = false;

        slotGiftContainer.innerHTML = '';
        slotGiftContainer.classList.remove('active', 'durov-cap');
        const plus = slotElement.querySelector('.plus-sign');
        if (plus) plus.style.opacity = '1';
        slotElement.classList.remove('filled');

        const removeBtn = slotElement.querySelector('.remove-gift');
        if (removeBtn) removeBtn.remove();

        updateCenterSquareHighlight();

        if (centerVideo) {
          centerVideo.pause();
          centerVideo.currentTime = 0;
          if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
        }
        updateModalSelection();
      }

      // ----- –û–ë–ù–û–í–õ–ï–ù–ò–ï –í–´–î–ï–õ–ï–ù–ò–Ø –í –ú–û–î–ê–õ–ö–ï -----
      function updateModalSelection() {
        const giftItems = document.querySelectorAll('.gift-item');
        giftItems.forEach(item => {
          item.classList.remove('selected');
          const rm = item.querySelector('.remove-selected');
          if (rm) rm.remove();
        });
        selectedGifts.forEach((gift, idx) => {
          if (!gift) return;
          const target = Array.from(giftItems).find(item => item.dataset.name === gift.name);
          if (target) {
            target.classList.add('selected');
            if (!target.querySelector('.remove-selected')) {
              const rm = document.createElement('div');
              rm.className = 'remove-selected';
              rm.innerHTML = '√ó';
              rm.onclick = (e) => removeGiftFromSlot(idx, e);
              target.appendChild(rm);
            }
          }
        });
      }

      // ----- –°–û–ó–î–ê–ù–ò–ï 3D –ö–£–ë–ê (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) -----
      async function createGiftCube() {
        const faces = [
          document.getElementById('cube-face-0'),
          document.getElementById('cube-face-1'),
          document.getElementById('cube-face-2'),
          document.getElementById('cube-face-3')
        ];
        for (let i = 0; i < faces.length; i++) {
          if (faces[i] && selectedGifts[i]) {
            faces[i].innerHTML = '';
            faces[i].appendChild(await createSlotGiftContent(selectedGifts[i]));
          }
        }
        const top = document.querySelector('.cube-face.top');
        const bottom = document.querySelector('.cube-face.bottom');
        if (top && bottom && selectedGifts[0]) {
          top.innerHTML = '<div class="selected-gift active"><div class="gift-emoji">‚ú®</div></div>';
          bottom.innerHTML = '<div class="selected-gift active"><div class="gift-emoji">üí´</div></div>';
        }
      }

      async function mergeToCube() {
        const corners = document.getElementById('cornersContainer');
        const center = document.getElementById('centerSquare');
        const cubeContainer = document.getElementById('giftCubeContainer');
        if (corners) corners.classList.add('merged');
        if (center) center.classList.add('merged');
        await createGiftCube();
        if (cubeContainer) cubeContainer.classList.add('active');
      }

      // ----- –ü–û–ò–°–ö (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -----
      function getSearchScore(name, term) {
        const low = name.toLowerCase();
        if (low.startsWith(term)) return 1000;
        if (low.includes(' ' + term)) return 800;
        if (low[0] === term[0]) return 500;
        if (low.includes(term)) return 100;
        return 0;
      }

      function sortGiftsByRelevance(gifts, term) {
        if (!term) return gifts;
        term = term.toLowerCase();
        return gifts.sort((a, b) => {
          const sa = getSearchScore(a.name, term);
          const sb = getSearchScore(b.name, term);
          return sb - sa || a.name.localeCompare(b.name);
        });
      }

      // ----- –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –û–¢–†–ò–°–û–í–ö–ê –°–ï–¢–ö–ò (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) -----
      async function filterAndSortGifts(searchTerm) {
        const filtered = rareGifts.filter(g => g.name.toLowerCase().includes(searchTerm.toLowerCase()));
        const sorted = sortGiftsByRelevance(filtered, searchTerm);
        const grid = document.getElementById('giftsGrid');
        if (!grid) return;
        grid.innerHTML = '';

        for (const gift of sorted) {
          const item = document.createElement('div');
          item.className = 'gift-item';
          item.dataset.name = gift.name;

          const imgDiv = await createCatalogGiftElement(gift);
          const nameDiv = document.createElement('div');
          nameDiv.className = 'gift-name';
          nameDiv.textContent = gift.name;

          item.appendChild(imgDiv);
          item.appendChild(nameDiv);
          item.onclick = () => selectGiftForSlot(gift, currentSlotElement);
          grid.appendChild(item);
        }

        updateModalSelection();
      }

      // ----- –ü–û–ö–ê–ó –ú–û–î–ê–õ–ö–ò -----
      function showGifts(slotElement) {
        if (!slotElement) return;
        currentSelectedSlot = slotElement.dataset.slot;
        currentSlotElement = slotElement;
        filterAndSortGifts('');
        const modal = document.getElementById('giftModal');
        if (modal) modal.classList.add('active');
      }

      // ----- –í–´–ë–û–† –ü–û–î–ê–†–ö–ê –î–õ–Ø –°–õ–û–¢–ê (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) -----
      async function selectGiftForSlot(gift, slotElement) {
        if (!slotElement) return;
        const slotIndex = parseInt(currentSelectedSlot);
        if (filledSlots[slotIndex]) return;

        const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);
        if (!slotGiftContainer) return;

        selectedGifts[slotIndex] = gift;
        filledSlots[slotIndex] = true;

        slotGiftContainer.innerHTML = '';
        slotGiftContainer.appendChild(await createSlotGiftContent(gift));
        slotGiftContainer.classList.add('active');
        if (gift.name === "Durov's Cap") slotGiftContainer.classList.add('durov-cap');

        const plus = slotElement.querySelector('.plus-sign');
        if (plus) plus.style.opacity = '0';
        slotElement.classList.add('filled');

        const removeBtn = document.createElement('div');
        removeBtn.className = 'remove-gift';
        removeBtn.innerHTML = '√ó';
        removeBtn.onclick = (e) => removeGiftFromSlot(slotIndex, e);
        slotElement.appendChild(removeBtn);

        const filledCount = filledSlots.filter(Boolean).length;
        if (filledCount === 4) {
          fourthGiftSelected = true;
          if (centerVideo) {
            centerVideo.pause();
            centerVideo.currentTime = 0;
            if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
          }
          updateCenterSquareHighlight();
        } else {
          playVideoFromStart();
          updateCenterSquareHighlight();
        }

        updateModalSelection();
        const modal = document.getElementById('giftModal');
        if (modal) modal.classList.remove('active');
      }

      // ----- –£–°–¢–ê–ù–û–í–ö–ê –°–ö–û–†–û–°–¢–ò –û–°–ù–û–í–ù–û–ì–û –í–ò–î–ï–û -----
      const mainVideo = document.querySelector('#videoWrapper video');
      if (mainVideo) mainVideo.playbackRate = 0.7;

      // ----- –ó–ê–ü–£–°–ö –ò–ù–¢–ï–†–§–ï–ô–°–ê -----
      const user = tg.initDataUnsafe?.user;
      if (user && user.photo_url) {
        const avatar = document.getElementById('avatar');
        if (avatar) {
          const img = document.createElement('img');
          img.src = user.photo_url;
          avatar.appendChild(img);
        }

        setTimeout(() => {
          const matrix = document.getElementById('matrix');
          const wrapper = document.getElementById('videoWrapper');
          const black = document.getElementById('blackScreen');
          if (matrix) matrix.style.opacity = '0';
          if (wrapper) wrapper.style.opacity = '0';
          if (black) black.style.opacity = '1';
        }, 3000);

        setTimeout(() => {
          if (avatar) avatar.style.opacity = '1';
          const mainSquare = document.getElementById('mainSquare');
          if (mainSquare) mainSquare.style.opacity = '1';

          document.querySelectorAll('.mini-square').forEach(sq => {
            sq.onclick = (e) => {
              if (e.target.classList.contains('remove-gift')) return;
              showGifts(sq);
            };
          });

          const center = document.getElementById('centerSquare');
          if (center) {
            center.onclick = () => {
              if (filledSlots.filter(Boolean).length === 4) mergeToCube();
            };
          }
        }, 3500);
      }

      // ----- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ú–û–î–ê–õ–ö–ò -----
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => filterAndSortGifts(e.target.value));
      }

      const closeBtn = document.getElementById('closeModal');
      if (closeBtn) {
        closeBtn.onclick = () => {
          const modal = document.getElementById('giftModal');
          if (modal) modal.classList.remove('active');
        };
      }

      const modal = document.getElementById('giftModal');
      if (modal) {
        modal.onclick = (e) => {
          if (e.target === modal) modal.classList.remove('active');
        };
      }

    } catch (err) {
      console.error('Init error:', err);
      document.body.innerHTML = '<div style="color:white;padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
    }
  }
})();
</script>
</body>
</html>—ã