<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,
                 height=device-height,
                 initial-scale=1.0,
                 maximum-scale=1.0,
                 user-scalable=no" />
  <title>Telegram Roulette</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –í—Å–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–æ–ø–∏—Ä—É–µ–º –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞) */
    /* ... (–¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –Ω–µ –ø—Ä–∏–≤–æ–∂—É, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å) */
  </style>
</head>
<body>
<div id="app">
  <!-- –í—Å—è —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
  <!-- ... -->
</div>
<div class="modal" id="giftModal"><!-- ... --></div>

<script>
  (function() {
    const tg = Telegram.WebApp;
    tg.ready();
    tg.expand();

    // ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
    const MAIN_VIDEO_SRC = 'roulette.webm';
    const CENTER_VIDEO_SRC = 'center-video.mp4';

    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    let selectedGifts = [null, null, null, null];
    let filledSlots = [false, false, false, false];
    let fourthGiftSelected = false;
    let videoPlayTimeout = null;
    let currentSelectedSlot = null;
    let currentSlotElement = null;

    // –î–∞–Ω–Ω—ã–µ –∏–∑ manifest.json
    let pngSet = new Set();
    let mp4Set = new Set();
    let manifestLoaded = false;

    // ========== –ö–ê–¢–ê–õ–û–ì –ü–û–î–ê–†–ö–û–í (—Ç–æ–ª—å–∫–æ –∏–º–µ–Ω–∞ –∏ —ç–º–æ–¥–∑–∏) ==========
    const rareGifts = [
      { name: "Durov's Cap", emoji: "üé©" },
      { name: "Top Hat", emoji: "üé©" },
      { name: "Astral Shard", emoji: "üíé" },
      { name: "Mini Oscar", emoji: "üèÜ" },
      { name: "Electric Skull", emoji: "üíÄ" },
      // ... (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞)
    ];

    // ========== –ó–ê–ì–†–£–ó–ö–ê MANIFEST ==========
    async function loadManifest() {
      try {
        const response = await fetch('videos/manifest.json');
        if (!response.ok) throw new Error('Manifest not found');
        const manifest = await response.json();
        pngSet = new Set(manifest.png || []);
        mp4Set = new Set(manifest.mp4 || []);
        manifestLoaded = true;
        console.log('Manifest loaded');
      } catch (e) {
        console.warn('Manifest loading failed, using fallback mode');
        manifestLoaded = false;
      }
    }

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è PNG –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞
    function hasPng(gift) {
      return manifestLoaded ? pngSet.has(gift.name + '.png') : true;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è MP4 –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞
    function hasMp4(gift) {
      return manifestLoaded ? mp4Set.has(gift.name + '.mp4') : true;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ö–ê–¢–ê–õ–û–ì–ï (–≤—Å–µ–≥–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å PNG)
    function createCatalogGiftElement(gift) {
      const container = document.createElement('div');
      container.className = 'gift-img';

      if (hasPng(gift)) {
        const img = new Image();
        img.src = `videos/${encodeURIComponent(gift.name)}.png`;
        img.alt = gift.name;
        img.onerror = () => {
          // –µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ —ç–º–æ–¥–∑–∏
          container.innerHTML = '';
          const emoji = document.createElement('div');
          emoji.className = 'gift-emoji';
          emoji.textContent = gift.emoji;
          container.appendChild(emoji);
        };
        container.appendChild(img);
      } else {
        const emoji = document.createElement('div');
        emoji.className = 'gift-emoji';
        emoji.textContent = gift.emoji;
        container.appendChild(emoji);
      }
      return container;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è –°–õ–û–¢–ê –∏–ª–∏ –ö–£–ë–ê (–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ, –∏–Ω–∞—á–µ –∫–∞—Ä—Ç–∏–Ω–∫—É, –∏–Ω–∞—á–µ —ç–º–æ–¥–∑–∏)
    function createSlotGiftContent(gift) {
      const wrapper = document.createElement('div');
      wrapper.className = 'selected-gift active';

      const tryShowVideo = () => {
        if (hasMp4(gift)) {
          const video = document.createElement('video');
          video.className = 'gift-img';
          video.src = `videos/${encodeURIComponent(gift.name)}.mp4`;
          video.muted = true;
          video.loop = true;
          video.autoplay = true;
          video.playsInline = true;
          video.setAttribute('webkit-playsinline', '');
          // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è (—Ä–µ–¥–∫–æ), –ø–æ–∫–∞–∂–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ —ç–º–æ–¥–∑–∏
          video.onerror = () => {
            wrapper.innerHTML = ''; // –æ—á–∏—â–∞–µ–º
            tryShowImage(); // –ø—Ä–æ–±—É–µ–º –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É
          };
          wrapper.appendChild(video);
          return true;
        }
        return false;
      };

      const tryShowImage = () => {
        if (hasPng(gift)) {
          const img = new Image();
          img.className = 'gift-img';
          img.src = `videos/${encodeURIComponent(gift.name)}.png`;
          img.alt = gift.name;
          img.onerror = () => {
            wrapper.innerHTML = '';
            const emoji = document.createElement('div');
            emoji.className = 'gift-emoji';
            emoji.textContent = gift.emoji;
            wrapper.appendChild(emoji);
          };
          wrapper.appendChild(img);
        } else {
          const emoji = document.createElement('div');
          emoji.className = 'gift-emoji';
          emoji.textContent = gift.emoji;
          wrapper.appendChild(emoji);
        }
      };

      if (!tryShowVideo()) {
        tryShowImage();
      }
      return wrapper;
    }

    // ========== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –í–ò–î–ï–û–¶–ï–ù–¢–†–û–ú ==========
    const centerVideo = document.querySelector('.center-video');
    if (centerVideo) {
      centerVideo.pause();
      centerVideo.currentTime = 0;
    }

    function playVideoFromStart() {
      if (centerVideo && !fourthGiftSelected) {
        if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
        centerVideo.currentTime = 0;
        centerVideo.play().catch(() => {});
        videoPlayTimeout = setTimeout(() => {
          centerVideo.pause();
          centerVideo.currentTime = 0;
        }, 2000);
      }
    }

    function updateCenterSquareHighlight() {
      const centerSquare = document.getElementById('centerSquare');
      const filledCount = filledSlots.filter(Boolean).length;
      if (filledCount > 0 && filledCount < 4 && !fourthGiftSelected) {
        centerSquare.classList.add('active-video');
      } else if (filledCount === 4) {
        centerSquare.classList.remove('active-video');
        centerSquare.classList.add('completed');
      } else {
        centerSquare.classList.remove('active-video', 'completed');
      }
    }

    // ========== –£–î–ê–õ–ï–ù–ò–ï –ü–û–î–ê–†–ö–ê –ò–ó –°–õ–û–¢–ê ==========
    function removeGiftFromSlot(slotIndex, event) {
      event.stopPropagation();
      const slotElement = document.querySelector(`.mini-square[data-slot="${slotIndex}"]`);
      const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);

      selectedGifts[slotIndex] = null;
      filledSlots[slotIndex] = false;
      fourthGiftSelected = false;

      slotGiftContainer.innerHTML = '';
      slotGiftContainer.classList.remove('active', 'durov-cap');
      slotElement.querySelector('.plus-sign').style.opacity = '1';
      slotElement.classList.remove('filled');

      const removeBtn = slotElement.querySelector('.remove-gift');
      if (removeBtn) removeBtn.remove();

      updateCenterSquareHighlight();

      if (centerVideo) {
        centerVideo.pause();
        centerVideo.currentTime = 0;
        if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
      }

      updateModalSelection();
    }

    // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –í–´–î–ï–õ–ï–ù–ò–Ø –í –ú–û–î–ê–õ–ö–ï ==========
    function updateModalSelection() {
      const giftItems = document.querySelectorAll('.gift-item');
      giftItems.forEach(item => {
        item.classList.remove('selected');
        const removeBtn = item.querySelector('.remove-selected');
        if (removeBtn) removeBtn.remove();
      });

      selectedGifts.forEach((gift, idx) => {
        if (gift) {
          const targetItem = Array.from(giftItems).find(item => item.dataset.name === gift.name);
          if (targetItem) {
            targetItem.classList.add('selected');
            if (!targetItem.querySelector('.remove-selected')) {
              const rm = document.createElement('div');
              rm.className = 'remove-selected';
              rm.innerHTML = '√ó';
              rm.onclick = (e) => removeGiftFromSlot(idx, e);
              targetItem.appendChild(rm);
            }
          }
        }
      });
    }

    // ========== –°–û–ó–î–ê–ù–ò–ï 3D –ö–£–ë–ê ==========
    function createGiftCube() {
      const faces = [
        document.getElementById('cube-face-0'),
        document.getElementById('cube-face-1'),
        document.getElementById('cube-face-2'),
        document.getElementById('cube-face-3')
      ];
      faces.forEach((face, i) => {
        if (selectedGifts[i]) {
          face.innerHTML = '';
          face.appendChild(createSlotGiftContent(selectedGifts[i]));
        }
      });
      const top = document.querySelector('.cube-face.top');
      const bottom = document.querySelector('.cube-face.bottom');
      if (selectedGifts[0]) {
        top.innerHTML = '<div class="selected-gift active"><div class="gift-emoji">‚ú®</div></div>';
        bottom.innerHTML = '<div class="selected-gift active"><div class="gift-emoji">üí´</div></div>';
      }
    }

    function mergeToCube() {
      document.getElementById('cornersContainer').classList.add('merged');
      document.getElementById('centerSquare').classList.add('merged');
      createGiftCube();
      document.getElementById('giftCubeContainer').classList.add('active');
    }

    // ========== –ü–û–ò–°–ö ==========
    function sortGiftsByRelevance(gifts, term) {
      if (!term) return gifts;
      term = term.toLowerCase();
      return gifts.sort((a, b) => {
        const sa = getSearchScore(a.name, term);
        const sb = getSearchScore(b.name, term);
        return sb - sa || a.name.localeCompare(b.name);
      });
    }
    function getSearchScore(name, term) {
      const low = name.toLowerCase();
      if (low.startsWith(term)) return 1000;
      if (low.includes(' ' + term)) return 800;
      if (low[0] === term[0]) return 500;
      if (low.includes(term)) return 100;
      return 0;
    }

    // ========== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –û–¢–†–ò–°–û–í–ö–ê –°–ï–¢–ö–ò ==========
    function filterAndSortGifts(searchTerm) {
      const filtered = rareGifts.filter(g => g.name.toLowerCase().includes(searchTerm.toLowerCase()));
      const sorted = sortGiftsByRelevance(filtered, searchTerm);

      const grid = document.getElementById('giftsGrid');
      grid.innerHTML = '';

      sorted.forEach(gift => {
        const item = document.createElement('div');
        item.className = 'gift-item';
        item.dataset.name = gift.name;

        const imgDiv = createCatalogGiftElement(gift);
        const nameDiv = document.createElement('div');
        nameDiv.className = 'gift-name';
        nameDiv.textContent = gift.name;

        item.appendChild(imgDiv);
        item.appendChild(nameDiv);
        item.onclick = () => selectGiftForSlot(gift, currentSlotElement);
        grid.appendChild(item);
      });

      updateModalSelection();
    }

    // ========== –ü–û–ö–ê–ó –ú–û–î–ê–õ–ö–ò ==========
    function showGifts(slotElement) {
      currentSelectedSlot = slotElement.dataset.slot;
      currentSlotElement = slotElement;
      filterAndSortGifts('');
      document.getElementById('giftModal').classList.add('active');
    }

    // ========== –í–´–ë–û–† –ü–û–î–ê–†–ö–ê –î–õ–Ø –°–õ–û–¢–ê ==========
    function selectGiftForSlot(gift, slotElement) {
      const slotIndex = parseInt(currentSelectedSlot);
      if (filledSlots[slotIndex]) return;

      const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);
      selectedGifts[slotIndex] = gift;
      filledSlots[slotIndex] = true;

      slotGiftContainer.innerHTML = '';
      slotGiftContainer.appendChild(createSlotGiftContent(gift));
      slotGiftContainer.classList.add('active');
      if (gift.name === "Durov's Cap") slotGiftContainer.classList.add('durov-cap');

      slotElement.querySelector('.plus-sign').style.opacity = '0';
      slotElement.classList.add('filled');

      const removeBtn = document.createElement('div');
      removeBtn.className = 'remove-gift';
      removeBtn.innerHTML = '√ó';
      removeBtn.onclick = (e) => removeGiftFromSlot(slotIndex, e);
      slotElement.appendChild(removeBtn);

      const filledCount = filledSlots.filter(Boolean).length;
      if (filledCount === 4) {
        fourthGiftSelected = true;
        if (centerVideo) {
          centerVideo.pause();
          centerVideo.currentTime = 0;
          if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
        }
        updateCenterSquareHighlight();
      } else {
        playVideoFromStart();
        updateCenterSquareHighlight();
      }

      updateModalSelection();
      document.getElementById('giftModal').classList.remove('active');
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    async function init() {
      await loadManifest();

      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ
      const mainVideo = document.querySelector('#videoWrapper video');
      if (mainVideo) mainVideo.playbackRate = 0.7;

      const user = tg.initDataUnsafe?.user;
      if (user && user.photo_url) {
        const avatar = document.getElementById("avatar");
        const img = document.createElement("img");
        img.src = user.photo_url;
        avatar.appendChild(img);

        setTimeout(() => {
          document.getElementById("matrix").style.opacity = "0";
          document.getElementById("videoWrapper").style.opacity = "0";
          document.getElementById("blackScreen").style.opacity = "1";
        }, 3000);

        setTimeout(() => {
          avatar.style.opacity = "1";
          document.getElementById("mainSquare").style.opacity = "1";

          document.querySelectorAll('.mini-square').forEach(sq => {
            sq.onclick = (e) => {
              if (e.target.classList.contains('remove-gift')) return;
              showGifts(sq);
            };
          });

          document.getElementById('centerSquare').onclick = () => {
            if (filledSlots.filter(Boolean).length === 4) mergeToCube();
          };
        }, 3500);
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª–∫–∏
      document.getElementById('searchInput')?.addEventListener('input', (e) => filterAndSortGifts(e.target.value));
      document.getElementById('closeModal').onclick = () => document.getElementById('giftModal').classList.remove('active');
      document.getElementById('giftModal').onclick = (e) => {
        if (e.target === document.getElementById('giftModal')) {
          document.getElementById('giftModal').classList.remove('active');
        }
      };
    }

    // –°—Ç–∞—Ä—Ç
    init();
  })();
</script>
</body>
</html>