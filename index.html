<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,
                 height=device-height,
                 initial-scale=1.0,
                 maximum-scale=1.0,
                 user-scalable=no" />
  <title>Telegram Roulette</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –í—Å–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ –±–µ–∑ –µ–¥–∏–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è */
    /* (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –≤–∞—à–µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–¥–∞) */
  </style>
</head>
<body>
<div id="app">
  <!-- –í—Å—è —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
</div>
<div class="modal" id="giftModal"><!-- ... --></div>

<script>
  const tg = Telegram.WebApp;
  tg.ready();
  tg.expand();

  document.querySelector('#videoWrapper video').playbackRate = 0.7;

  const centerVideo = document.querySelector('.center-video');
  if (centerVideo) {
    centerVideo.pause();
    centerVideo.currentTime = 0;
  }

  let selectedGifts = [null, null, null, null];
  let currentSelectedSlot = null;
  let currentSlotElement = null;
  let filledSlots = new Array(4).fill(false);
  let videoPlayTimeout = null;
  let fourthGiftSelected = false;

  // –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–¥–∞—Ä–∫–æ–≤ (–∏–º–µ–Ω–∞ –∏ —ç–º–æ–¥–∑–∏) - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const rareGifts = [ /* ... –≤–∞—à –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ ... */ ];

  // –ú–∞—Ç—Ä–∏—Ü–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  const canvas = document.getElementById("matrix");
  const ctx = canvas.getContext("2d");
  let drops = [];
  const chars = "01ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789";
  const fontSize = 14;

  function initMatrix() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const columns = Math.floor(canvas.width / fontSize);
    drops = Array.from({ length: columns }, () => ({
      y: Math.random() * canvas.height,
      speed: 0.5 + Math.random() * 1.5
    }));
  }

  function drawMatrix() {
    ctx.fillStyle = "rgba(0, 0, 0, 0.08)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#00ff88";
    ctx.font = fontSize + "px monospace";
    drops.forEach((drop, i) => {
      const text = chars[Math.floor(Math.random() * chars.length)];
      ctx.fillText(text, i * fontSize, drop.y);
      drop.y += fontSize * drop.speed;
      if (drop.y > canvas.height + 50) {
        drop.y = Math.random() * -100;
        drop.speed = 0.5 + Math.random() * 1.5;
      }
    });
  }

  initMatrix();
  window.addEventListener("resize", initMatrix);
  setInterval(drawMatrix, 50);

  function playVideoFromStart() {
    if (centerVideo && !fourthGiftSelected) {
      if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
      centerVideo.currentTime = 0;
      centerVideo.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ'));
      videoPlayTimeout = setTimeout(() => {
        centerVideo.pause();
        centerVideo.currentTime = 0;
      }, 2000);
    }
  }

  function updateCenterSquareHighlight() {
    const centerSquare = document.getElementById('centerSquare');
    const filledCount = filledSlots.filter(filled => filled).length;
    if (filledCount > 0 && filledCount < 4 && !fourthGiftSelected) {
      centerSquare.classList.add('active-video');
    } else if (filledCount === 4) {
      centerSquare.classList.remove('active-video');
      centerSquare.classList.add('completed');
    } else {
      centerSquare.classList.remove('active-video', 'completed');
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ–¥–∞—Ä–∫–∞ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ) —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
  function createGiftContent(gift, forSlot = false) {
    const container = document.createElement('div');
    container.className = 'selected-gift active';

    const tryCreateVideo = () => {
      const video = document.createElement('video');
      video.className = 'gift-img';
      video.src = `videos/${encodeURIComponent(gift.name)}.mp4`;
      video.muted = true;
      video.loop = true;
      video.autoplay = true;
      video.playsInline = true;
      video.setAttribute('webkit-playsinline', '');
      
      video.onerror = () => {
        const img = new Image();
        img.onload = () => {
          container.innerHTML = '';
          img.className = 'gift-img';
          container.appendChild(img);
        };
        img.onerror = () => {
          container.innerHTML = '';
          const emoji = document.createElement('div');
          emoji.className = 'gift-emoji';
          emoji.textContent = gift.emoji;
          container.appendChild(emoji);
        };
        img.src = `videos/${encodeURIComponent(gift.name)}.png`;
      };
      
      video.oncanplay = () => video.play().catch(() => {});
      return video;
    };

    if (forSlot) {
      const video = tryCreateVideo();
      container.appendChild(video);
    } else {
      const img = new Image();
      img.onload = () => {
        img.className = 'gift-img';
        container.appendChild(img);
      };
      img.onerror = () => {
        const emoji = document.createElement('div');
        emoji.className = 'gift-emoji';
        emoji.textContent = gift.emoji;
        container.appendChild(emoji);
      };
      img.src = `videos/${encodeURIComponent(gift.name)}.png`;
    }

    return container;
  }

  function removeGiftFromSlot(slotIndex, event) {
    event.stopPropagation();
    const slotElement = document.querySelector(`.mini-square[data-slot="${slotIndex}"]`);
    const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);

    selectedGifts[slotIndex] = null;
    filledSlots[slotIndex] = false;
    fourthGiftSelected = false;

    slotGiftContainer.innerHTML = '';
    slotGiftContainer.classList.remove('active', 'durov-cap');
    slotElement.querySelector('.plus-sign').style.opacity = '1';
    slotElement.classList.remove('filled');

    const removeBtn = slotElement.querySelector('.remove-gift');
    if (removeBtn) removeBtn.remove();

    updateCenterSquareHighlight();

    if (centerVideo) {
      centerVideo.pause();
      centerVideo.currentTime = 0;
      if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
    }

    updateModalSelection();
  }

  function updateModalSelection() {
    const giftItems = document.querySelectorAll('.gift-item');
    giftItems.forEach(item => {
      item.classList.remove('selected');
      const removeBtn = item.querySelector('.remove-selected');
      if (removeBtn) removeBtn.remove();
    });

    selectedGifts.forEach((gift, index) => {
      if (gift) {
        const giftItem = Array.from(giftItems).find(item => item.dataset.name === gift.name);
        if (giftItem) {
          giftItem.classList.add('selected');
          if (!giftItem.querySelector('.remove-selected')) {
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-selected';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = (e) => {
              e.stopPropagation();
              removeGiftFromSlot(index, e);
            };
            giftItem.appendChild(removeBtn);
          }
        }
      }
    });
  }

  function createGiftCube() {
    const cubeFaces = [
      document.getElementById('cube-face-0'),
      document.getElementById('cube-face-1'),
      document.getElementById('cube-face-2'),
      document.getElementById('cube-face-3')
    ];

    cubeFaces.forEach((face, index) => {
      if (selectedGifts[index]) {
        const gift = selectedGifts[index];
        const content = createGiftContent(gift, true);
        face.innerHTML = '';
        face.appendChild(content);
      }
    });

    const topFace = document.querySelector('.cube-face.top');
    const bottomFace = document.querySelector('.cube-face.bottom');
    if (selectedGifts[0]) {
      topFace.innerHTML = '<div class="selected-gift active"><div class="gift-emoji">‚ú®</div></div>';
      bottomFace.innerHTML = '<div class="selected-gift active"><div class="gift-emoji">üí´</div></div>';
    }
  }

  function mergeToCube() {
    const cornersContainer = document.getElementById('cornersContainer');
    const centerSquare = document.getElementById('centerSquare');
    const giftCubeContainer = document.getElementById('giftCubeContainer');

    cornersContainer.classList.add('merged');
    centerSquare.classList.add('merged');

    createGiftCube();
    giftCubeContainer.classList.add('active');
  }

  function sortGiftsByRelevance(gifts, searchTerm) {
    if (!searchTerm) return gifts;
    searchTerm = searchTerm.toLowerCase();
    return gifts.sort((a, b) => {
      const scoreA = getSearchScore(a.name, searchTerm);
      const scoreB = getSearchScore(b.name, searchTerm);
      if (scoreA !== scoreB) return scoreB - scoreA;
      return a.name.localeCompare(b.name);
    });
  }

  function getSearchScore(name, searchTerm) {
    const lowerName = name.toLowerCase();
    if (lowerName.startsWith(searchTerm)) return 1000;
    if (lowerName.includes(` ${searchTerm}`)) return 800;
    if (lowerName[0] === searchTerm[0]) return 500;
    if (lowerName.includes(searchTerm)) return 100;
    return 0;
  }

  function filterAndSortGifts(searchTerm) {
    const filteredGifts = rareGifts.filter(gift =>
      gift.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
    const sortedGifts = sortGiftsByRelevance(filteredGifts, searchTerm);

    const grid = document.getElementById('giftsGrid');
    grid.innerHTML = '';

    sortedGifts.forEach(gift => {
      const item = document.createElement('div');
      item.className = 'gift-item';
      item.dataset.name = gift.name;

      const img = document.createElement('img');
      img.className = 'gift-img';
      img.src = `videos/${encodeURIComponent(gift.name)}.png`;
      img.alt = gift.name;
      img.onerror = () => {
        img.style.display = 'none';
        const emojiDiv = document.createElement('div');
        emojiDiv.className = 'gift-emoji';
        emojiDiv.textContent = gift.emoji;
        img.parentNode.replaceChild(emojiDiv, img);
      };

      const giftImgDiv = document.createElement('div');
      giftImgDiv.className = 'gift-img';
      giftImgDiv.appendChild(img);

      const nameDiv = document.createElement('div');
      nameDiv.className = 'gift-name';
      nameDiv.textContent = gift.name;

      item.appendChild(giftImgDiv);
      item.appendChild(nameDiv);
      item.onclick = () => selectGiftForSlot(gift, currentSlotElement);
      grid.appendChild(item);
    });

    updateModalSelection();
  }

  function showGifts(slotElement) {
    currentSelectedSlot = slotElement.dataset.slot;
    currentSlotElement = slotElement;
    filterAndSortGifts('');
    document.getElementById('giftModal').classList.add('active');
  }

  function selectGiftForSlot(gift, slotElement) {
    const slotIndex = parseInt(currentSelectedSlot);
    if (filledSlots[slotIndex]) return;

    const slotGiftContainer = document.getElementById(`gift-slot-${slotIndex}`);
    selectedGifts[slotIndex] = gift;
    filledSlots[slotIndex] = true;

    slotGiftContainer.innerHTML = '';
    const content = createGiftContent(gift, true);
    slotGiftContainer.appendChild(content);

    slotGiftContainer.classList.add('active');
    if (gift.name === "Durov's Cap") slotGiftContainer.classList.add('durov-cap');

    slotElement.querySelector('.plus-sign').style.opacity = '0';
    slotElement.classList.add('filled');

    const removeBtn = document.createElement('div');
    removeBtn.className = 'remove-gift';
    removeBtn.innerHTML = '√ó';
    removeBtn.onclick = (e) => removeGiftFromSlot(slotIndex, e);
    slotElement.appendChild(removeBtn);

    const filledCount = filledSlots.filter(filled => filled).length;
    if (filledCount === 4) {
      fourthGiftSelected = true;
      if (centerVideo) {
        centerVideo.pause();
        centerVideo.currentTime = 0;
        if (videoPlayTimeout) clearTimeout(videoPlayTimeout);
      }
      updateCenterSquareHighlight();
    } else {
      playVideoFromStart();
      updateCenterSquareHighlight();
    }

    updateModalSelection();
    document.getElementById('giftModal').classList.remove('active');
  }

  const user = tg.initDataUnsafe?.user;
  if (user && user.photo_url) {
    const avatar = document.getElementById("avatar");
    const img = document.createElement("img");
    img.src = user.photo_url;
    avatar.appendChild(img);

    setTimeout(() => {
      document.getElementById("matrix").style.opacity = "0";
      document.getElementById("videoWrapper").style.opacity = "0";
      document.getElementById("blackScreen").style.opacity = "1";
    }, 3000);

    setTimeout(() => {
      avatar.style.opacity = "1";
      document.getElementById("mainSquare").style.opacity = "1";

      document.querySelectorAll('.mini-square').forEach(square => {
        square.onclick = (e) => {
          if (e.target.classList.contains('remove-gift')) return;
          showGifts(square);
        };
      });

      document.getElementById('centerSquare').onclick = () => {
        if (filledSlots.filter(filled => filled).length === 4) {
          mergeToCube();
        }
      };
    }, 3500);
  }

  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    filterAndSortGifts(e.target.value);
  });

  document.getElementById('closeModal').onclick = () => {
    document.getElementById('giftModal').classList.remove('active');
  };

  document.getElementById('giftModal').onclick = (e) => {
    if (e.target === document.getElementById('giftModal')) {
      document.getElementById('giftModal').classList.remove('active');
    }
  };

  // ========== –¢–ò–•–ê–Ø –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô –î–õ–Ø 4 –ü–û–î–ê–†–ö–û–í ==========
  // –≠—Ç–æ—Ç –∫–æ–¥ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞.
  (function preloadImages() {
    const giftsToPreload = [
      "Astral Shard",
      "Kissed Frog",
      "Durov's Cap",
      "Artisan Brick"
    ];
    giftsToPreload.forEach(name => {
      const img = new Image();
      img.src = `videos/${encodeURIComponent(name)}.png`;
      // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ, –Ω–æ —ç—Ç–æ —Ç—è–∂–µ–ª–µ–µ
    });
  })();
</script>
</body>
</html>